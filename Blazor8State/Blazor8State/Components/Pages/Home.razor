@page "/"
@attribute [StreamRendering]
@inject IHttpContextAccessor hca
@inject SessionManager sessions

<PageTitle>Home</PageTitle>

<h1>Hello, world!</h1>

Welcome to your new app.

<p>Cookie: @myCookieValue</p>

@if (session is not null)
{
    <p>State: @mystate</p>
}

@code
{
    private string myCookieValue = "<unread>";
    private Session session = new Session();
    private string mystate = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        var httpContext = hca.HttpContext;
        if (httpContext is not null && !httpContext.Request.Cookies.ContainsKey("sessionId"))
        {
            myCookieValue = Guid.NewGuid().ToString();
            httpContext.Response.Cookies.Append("sessionId", myCookieValue);
        }

        if (httpContext is not null && httpContext.Request.Cookies.ContainsKey("sessionId"))
        {
            myCookieValue = httpContext.Request.Cookies["sessionId"];
        }

        if (!sessions.Contains(myCookieValue))
        {
            session = new Session();
            sessions.Add(myCookieValue, session);
            session.Add("mystate", Guid.NewGuid().ToString());
        }
        else
        {
            session = await sessions.GetSession(myCookieValue);
        }
        mystate = (string)session["mystate"];
    }
}